# CPU의 동작 원리

> 기본적으로 ALU와 제어장치 그리고 레지스터로 구성된다는 것을 다시 기억해봅시다.

## ALU

- 레지스터에서 피연사자를 받고
- 제어장치에서 어떤 연산을 할지 정하고
- 연산을 수행한 후 결과를 레지스터에 넣는다.

ALU는 계산 결과와 더불어서 "플래그"를 같이 내보냅니다. 이 플래그는 연산결과와 더불어서 추가 정보를 나타냅니다.

플래그의 종류

- 부호 플래그 : 계산 결과가 음수인지 양수인지를 나타내는 플래그
- 오버플로우 플래그 : 계산 결과가 데이터 타입의 범위를 넘어서는지를 나타내는 플래그
- 제로 플래그 : 계산 결과가 0인지를 나타내는 플래그
- 캐리 플래그 : 계산 결과가 올림이 발생했는지를 나타내는 플래그
- 인터럽트 플래그 : 인터럽트가 발생했는지를 나타내는 플래그
- 슈퍼바이저 플래그 : 슈퍼바이저 모드에서 실행되고 있는지를 나타내는 플래그 (커널모드 or 사용자 모드)

## 제어장치

- 제어장치는 클럭 신호를 받아들이고 명령어를 읽어들인다.
- 명령어를 읽어들인 후에는 명령어의 종류에 따라서 다음을 수행한다.
  - 산술/논리 연산을 수행한다.
  - 데이터를 이동시킨다.
  - 프로그램의 실행 흐름을 제어한다.
- 플레그 레지스터 속 플래그 값을 받아들인다.
- 제어장치는 시스템버스, 중에 제어버스로 전달된 제어 신호를 받아들인다.

## 레지스터

반드시 알아야할 8가지 레지스터

- 프로그램 카운터
- 명령어 레지스터
- 메모리 주소 레지스터
- 메모리 버퍼 레지스터
- 플레그 레지스터
- 범용 레지스터
- 스택 포인터
- 베이스 레지스터

### 프로그램 카운터

메모리에서 읽어 들일 명령어의 주소를 저장, 명령어 포인터라고도 부른다.

### 명령어 레지스터

방금 읽어 들인 명령어를 저장하는 곳
해석하고 나서 제어 신호를 보냄

### 메모리 주소 레지스터

메모리의 주소를 저장

### 메모리 버퍼 레지스터

메모리와 주고 받을 값을 저장하는 레지스터
데이터와 명령어를 저장할 수 있다.
메모리 데이터 레지스터라고도 부른다.

### 범용레지스터

일반적인 상황에서 자유롭게 사용할 수 있다.
데이터와 주소 모두를 저장할 수 있다.

### 플래그 레지스터

ALU 연산 결과에 따른 플래그를 저장하는 곳

## 특정 레지스터를 이용한 주소 지정 방식 : 스택 주소 지정 방식

- 스택포인터 : 스택의 최상단을 가리키는 포인터
- 베이스 레지스터 : 스택의 최하단을 가리키는 포인터

## 특정 레지스터를 이용한 주소 지정 방식 : 변위 주소 지정 방식

## 인터럽트

크게 두가지의 종류를 갖고 있다.

1. 동기 인터럽트 : CPU에 의해 발생하는 인터럽트, 예외 라고도 부릅니다.
2. 비동기 인터럽트 : 주로 입출력 장치에 의해 발생하는 인터럽트, 주로 알림 역할을 합니다. 하드웨어 인터럽트라고 부를 수 있습니다.

## 하드웨어 인터럽트

알림이 없고, cpu가 계속 해당 작업이 끝났는지 확인해야한다면, 효율성이 떨어집니다. 그렇기 때문에 작업이 완료했을 때, cpu로 알림을 알려주는 기능이 필요합니다.

### 하드웨어 인터럽트 처리 순서

1. 입출력장치는 cpu에게 인터럽트 요청 신호를 보낸다.
2. cpu는 실행 사이클이 끝나고 명령어를 입력하기 인출하기 전 항상 인터럽트 여부를 확인
3. 인터럽트 플래그를 통해 현재 인터럽트를 받아들일 수 있는 지 확인
4. 받아들 일 수 있다면, 지금까지 작업 백업
5. 인터럽트 백터를 참조하여 인터럽트 서비스 루틴을 실행
6. 인터럽트 서비스 루틴이 끝나면, 백업해 둔 작업을 복구한 후 다시 실행

### 용어 정리

- 인터럽트 요청 신호 : CPU 인터럽트를 실행해도 되는 지 요청
- 인터럽트 플래그 : 인터럽트가 가능한지 여부에 대해 저장되어 있는 부분
- 하지만, 인터럽트 중에 우선 순위가 가장 높은 인터럽트들은 플래그와 상관없이 실행된다.
- 인터럽트 서비스 루틴 : 인터럽트를 처리하기 위한 프로그램, 인터럽트 핸들러라고도 부른다.
